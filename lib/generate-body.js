const generateBlobLink = require('./generate-blob-link')

const stripAt = str => {
  if (str.startsWith('@')) return str.substring(1)
  return str
}
const addAt = str => {
  if (!str.startsWith('@')) return `@${str}`
  return str
}

function generateAssignedTo (autoAssign, author) {
  if (autoAssign === true) {
    return `It's been assigned to @${author} because they committed the code.`
  } else if (autoAssign === false) {
    return ''
  } else if (typeof autoAssign === 'string') {
    const assigner = stripAt(autoAssign)
    return `It's been automagically assigned to @${assigner}.`
  } else if (Array.isArray(autoAssign)) {
    const assigners = autoAssign.map(user => addAt(user))
    const str = assigners.reduce((prev, user, i, arr) => i + 1 === arr.length ? prev + ` and ${user}` : prev + `, ${user}`, '')
    return `It's been automagically assigned to ${str}.`
  }
}

/**
 * @typedef config {object}
 * @prop {boolean|string|string[]} [autoAssign=true]
 * @prop {string} [keyword='@todo']
 * @prop {number|boolean} [blobLines=5]
 * @prop {boolean} [caseSensitive=false]
 *
 * Generate a body string for the new issue.
 * @param {object} context - Probot context object
 * @param {config} config - Config object
 * @param {string} title - Issue title
 * @param {string} file - File name
 * @param {string} contents - Contents of the file
 * @param {string} author - Author of the commit
 * @param {string} sha - Commit where this todo was introduced
 * @param {number|false} pr - PR number if applicable
 */
module.exports = function generateBody (context, config, title, file, contents, author, sha, pr) {
  const separator = '\n\n---\n\n'
  const footer = `###### This issue was generated by [todo](https://github.com/jasonetco/todo) based on a \`${config.keyword}\` comment in ${sha}${pr ? ` in #${pr}` : ''}. ${generateAssignedTo(config.autoAssign, author)}`

  const re = new RegExp(`${title}\n.*@body (.*)`, 'gim')
  const bodyRegex = re.exec(contents)
  const body = bodyRegex ? bodyRegex[1] + separator : ''

  const showBlob = config.blobLines !== false && config.blobLines !== 0
  const blob = showBlob ? generateBlobLink(context, file, contents, title, sha, config) + separator : ''

  return body + blob + footer
}
