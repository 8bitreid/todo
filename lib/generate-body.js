const generateBlobLink = require('./generate-blob-link')
const {reduceToList, addAt} = require('./helpers')

/**
 * Generates the assigned-to part of the footer string
 * @param {boolean|string|string[]} [autoAssign=true] - Auto assign config setting
 * @param {string} author - Commit author
 * @param {number|boolean} author - PR number or false
 * @returns {string}
 */
function generateAssignedTo (autoAssign = true, author, pr) {
  if (autoAssign === true) {
    return pr ? ` cc @${author}.` : ` It's been assigned to @${author} because they committed the code.`
  }

  if (autoAssign === false) {
    return ''
  }

  let assigner
  if (typeof autoAssign === 'string') {
    assigner = addAt(autoAssign)
  }

  if (Array.isArray(autoAssign)) {
    const assigners = autoAssign.map(user => addAt(user))
    assigner = reduceToList(assigners)
  }

  return pr ? ` cc ${assigner}` : ` It's been automagically assigned to ${assigner}.`
}

/**
 * @typedef config {object}
 * @prop {boolean|string|string[]} [autoAssign=true]
 * @prop {string} [keyword='@todo']
 * @prop {number|boolean} [blobLines=5]
 * @prop {boolean} [caseSensitive=false]
 *
 * Generate a body string for the new issue.
 * @param {object} context - Probot context object
 * @param {config} config - Config object
 * @param {string} title - Issue title
 * @param {string} file - File name
 * @param {string} contents - Contents of the file
 * @param {string} author - Author of the commit
 * @param {string} sha - Commit where this todo was introduced
 * @param {number|false} pr - PR number if applicable
 * @param {boolean} [prAddTitle=true] - Add the title to the comment body
 */
module.exports = function generateBody (context, config, title, file, contents, author, sha, pr, addTitle = true) {
  const separator = '\n\n---\n\n'
  const assignedToString = generateAssignedTo(config.autoAssign, author, pr)
  const footer = `###### This ${pr && addTitle ? 'comment' : 'issue'} was generated by [todo](https://todo.jasonet.co) based on a \`${config.keyword}\` comment in ${sha}${pr ? ` in #${pr}` : ''}.${assignedToString}`

  const re = new RegExp(`${title}\n.*${config.bodyKeyword} (.*)`, 'gim')
  const bodyRegex = re.exec(contents)
  let body = bodyRegex ? bodyRegex[1] + separator : ''

  const blob = config.blobLines ? generateBlobLink(context, file, contents, title, sha, config) + separator : ''

  const meta = `\n\n<!-- probot = ${JSON.stringify({[context.payload.installation.id]: {title, file, author, sha}})} -->`

  if (pr && addTitle) {
    return `## ${title}\n\n` + body + blob + footer + meta
  }
  return body + blob + footer + meta
}
